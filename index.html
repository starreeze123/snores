<!DOCTYPE html>
<html>

<head>
	<title>Snores Client</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="Expires" content="0">
	<meta http-equiv="Pragma" content="no-cache">
	<meta http-equiv="Cache-control" content="no-cache">
	<meta http-equiv="Cache" content="no-cache">
	<link rel="shortcut icon" href="assets/icon.png" />
	<style>
		body {
			font-family: Arial, sans-serif;
			background-color: #f4f4f9;
			color: #333;
			margin: 0;
			padding: 0;
		}

		h1 {
			text-align: center;
			color: #4CAF50;
			margin-top: 20px;
			margin-left: 10px;
		}

		h2 {
			color: #333;
			border-bottom: 2px solid #4CAF50;
			padding-bottom: 5px;
			margin-left: 10px;
		}

		p {
			margin: 10px 10px;
		}

		form {
			max-width: 600px;
			margin: 20px auto;
			background: #ffffff3f;
			padding: 20px;
			border-radius: 8px;
			box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
		}

		label {
			display: block;
			margin-bottom: 5px;
			font-weight: bold;
		}

		input[type="text"],
		input[type="password"],
		select {
			width: calc(100% - 20px);
			padding: 8px 10px;
			margin-bottom: 15px;
			border: 1px solid #ccc;
			border-radius: 4px;
		}

		input[type="checkbox"] {
			margin-right: 10px;
		}

		button {
			width: 100%;
			padding: 10px;
			background-color: #4CAF50;
			color: #fff;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 16px;
		}

		button:hover {
			background-color: #45a049;
		}

		#progress {
			width: 100%;
			background-color: #ddd;
			margin-top: 20px;
		}

		#progress_bar {
			width: 0;
			height: 30px;
			background-color: #4CAF50;
			line-height: 30px;
			color: white;
			text-align: center;
		}

		#order,
		#prompt {
			color: crimson;
			text-align: center;
			font-weight: bold;
			margin-top: 20px;
		}

		.alert {
			color: #333;
			background-color: #f8d7da47;
			padding: 15px;
			margin: 10px 0;
			border: 1px solid #f5c2c7;
			border-radius: 4px;
		}
	</style>
</head>

<body>
	<h1>SnoresğŸ’¤</h1>
	<p><b>S</b>cript for <b>N</b>JU Sp<b>o</b>rt <b>Re</b>servation <b>S</b>ystem</p>
	<p>Run this script and SNORE happily next morning - the server will do everything for you!</p>
	<p>Version 5.0.0, copyright (c) 2022~2024.</p>

	<h2>Usage</h2>
	<p>å¡«å†™ä¸‹é¢çš„ä¿¡æ¯ï¼Œç‚¹å‡» SNORES! å³å¯é¢„çº¦æ˜å¤©çš„åœºåœ°ã€‚<br>ç›®å‰ï¼ˆå…¶ä»–äººä½¿ç”¨æœ¬è„šæœ¬çš„ï¼‰é¢„çº¦æƒ…å†µï¼ˆè¯·ä¸»åŠ¨é¿å¼€ï¼Œå¦åˆ™ä¼šé¢„çº¦å¤±è´¥ï¼‰ï¼š</p>
	<p id="order">æ­£åœ¨åŠ è½½åœºåœ°ä¿¡æ¯ï¼Œè¯·ä¸è¦ç‚¹å‡»SNORESæŒ‰é’®â€¦â€¦</p>
	<p class="alert" style="color: blue;">5.0 èˆ¹æ–°ç‰ˆæœ¬å·²ä¸Šçº¿ï¼å…¨é¢é‡æ„åç«¯ï¼Œå¤§å¹…æé«˜å¯é æ€§å’Œå“åº”é€Ÿåº¦ï¼æ–°ç‰ˆæœ¬éš¾å…æœ‰ bugï¼Œè¯·ç§¯æåé¦ˆï¼Œè°¢è°¢ï¼</p>
	<p class="alert">å¦‚æœ‰å¯¹äºå‰ç«¯ UI çš„æ”¹è¿›æè®®ï¼Œè¯·æäº¤ pr åˆ° https://github.com/starreeze/snoresã€‚</p>

	<form>
		<label for="type">*åœºåœ°ç±»å‹:</label>
		<select id="type" name="type">
			<option value="120">æ–¹è‚‡å‘¨ç¾½æ¯›çƒï¼ˆæ¥¼ä¸‹ï¼‰</option>
			<option value="123">æ–¹è‚‡å‘¨ç¾½æ¯›çƒï¼ˆæ¥¼ä¸Šï¼‰</option>
			<option value="124">æ–¹è‚‡å‘¨ä¹’ä¹“çƒ</option>
			<option value="126" selected="selected">å››ç»„å›¢ç¾½æ¯›çƒ</option>
			<option value="127">é¼“æ¥¼ç¾½æ¯›çƒ</option>
		</select>

		<label for="time">*æ—¶é—´æ®µ:</label>
		<select id="time" name="time">
			<option value="9">9-10</option>
			<option value="10">10-11</option>
			<option value="11">11-12</option>
			<option value="12">12-13</option>
			<option value="13">13-14</option>
			<option value="14">14-15</option>
			<option value="15">15-16</option>
			<option value="16" selected="selected">16-17</option>
			<option value="17">17-18</option>
			<option value="18">18-19</option>
			<option value="19">19-20</option>
			<option value="20">20-21</option>
			<option value="21">21-22</option>
		</select>

		<label for="field">*åœºåœ° 1ï¼ˆç›´æ¥è¾“å…¥æ•°å­—ï¼‰:</label>
		<input type="text" id="field" name="field" value="2">

		<label for="user">*å­¦å·:</label>
		<input type="text" id="user">

		<label for="password">*ç»Ÿä¸€è®¤è¯å¯†ç :</label>
		<input type="password" id="password" name="password">

		<!-- <label for="alternative">åœºåœ° 2ï¼ˆç”¨äºå®¹é”™ï¼Œå¯ä¸å¡«ï¼‰:</label>
		<input type="text" id="alternative" name="alternative"> -->

		<input type="checkbox" id="fallback" name="fallback" checked="true">
		<label for="fallback">å¦‚æœè¯¥æ¡ä»¶æ— æ³•é€‰æ‹©ï¼Œå¸®æˆ‘é€‰æ‹©ä¸€ä¸ªå…¶ä»–åœºåœ°ï¼ˆä¼˜å…ˆåŒæ—¶é—´ï¼‰</label>

		<input type="checkbox" id="store_pwd" name="store_pwd" checked="true">
		<label for="store_pwd">å°†æˆ‘çš„è´¦å·å¯†ç ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­ï¼Œä¾¿äºä¸‹æ¬¡ä½¿ç”¨</label>

		<button type="button" onclick="run()" id="button">SNORES!</button>
	</form>

	<div id="progress">
		<div id="progress_bar"></div>
	</div>

	<p id="prompt" style="color: crimson;"></p>


	<h2>Introduction</h2>
	<p>å—äº¬å¤§å­¦ä½“è‚²åœºåœ°é¢„çº¦è„šæœ¬ï¼ˆå®¢æˆ·ç«¯ï¼‰ï¼Œç›®å‰ä»…æ”¯æŒç¾½æ¯›çƒã€ä¹’ä¹“çƒã€‚</p>
	<p>ç›®å‰ä¸ºé˜²æ­¢æ»¥ç”¨ï¼ŒæœåŠ¡ç«¯ä»…å¯¹å·²è·æˆæƒçš„è´¦æˆ·å¼€æ”¾é¢„çº¦æœåŠ¡ã€‚è¦è·å–æˆæƒï¼Œè¯·è”ç³»å¼€å‘è€…ã€‚å¦‚æœæ‚¨ä¸è®¤è¯†å¼€å‘è€…ï¼Œæƒ³å¿…æ‚¨ä¹Ÿä¸ä¼šæ”¾å¿ƒåœ°è¾“å…¥ç»Ÿä¸€è®¤è¯è´¦å·å’Œå¯†ç ã€‚</p>
	<p>å½“å¤© 8 ç‚¹å‰è¿è¡Œå®¢æˆ·ç«¯å‘é€è¯·æ±‚ï¼ŒæœåŠ¡å™¨ä¼šåœ¨ 8 ç‚¹æ•´å¼€å§‹æ‰§è¡Œé¢„çº¦æ“ä½œã€‚æœåŠ¡ç«¯ç¨‹åºä¼šè°ƒå‡ºæµè§ˆå™¨ï¼Œå¹¶è‡ªåŠ¨å®Œæˆç™»å½•ã€é€‰æ‹©åœºåœ°ã€é€‰æ‹©åŒä¼´ã€æ»‘åŠ¨éªŒè¯ç ã€æ”¯ä»˜ç­‰æ“ä½œï¼Œå¯ä»¥æ¯”æ‰‹åŠ¨æ“ä½œèŠ‚çœ
		2-3sï¼Œæé«˜æˆåŠŸç‡ï¼›åŒæ—¶å†ä¹Ÿä¸ç”¨æ€•æ—© 8 èµ·ä¸æ¥äº†ã€‚</p>
	<p>ç›®å‰ä¿¡æ¯ä½¿ç”¨æ˜æ–‡ä¼ è¾“ï¼Œè¯·ç¡®ä¿ç½‘ç»œç¯å¢ƒå®‰å…¨ï¼›å¼€å‘è€…æ‰¿è¯ºï¼Œä¸ä¼šå°†ç”¨æˆ·ä¿¡æ¯å’Œå¯†ç ç”¨äºé™¤ç™»å½•é¢„çº¦ç³»ç»Ÿå¤–çš„ä»»ä½•ç”¨é€”ï¼›æœåŠ¡å™¨åœ¨æ ¡å†…ï¼Œä¸€æ—¦å‡ºç°é—®é¢˜å¯æº¯æºï¼šè¯·æ”¾å¿ƒä½¿ç”¨ã€‚</p>
	<p>ä½¿ç”¨å‰è¯·ç¡®ä¿åœ¨ç³»ç»Ÿä¸­æ·»åŠ äº†è‡³å°‘ä¸€ä¸ªåŒä¼´ï¼Œå°†ä¼šé»˜è®¤ä½¿ç”¨ç¬¬ä¸€ä¸ªåŒä¼´ã€‚</p>

	<h2>Known Issues</h2>
	<p>client&serverï¼šæœ‰æ—¶å®¢æˆ·ç«¯ä¼šå› ä¸ºç½‘ç»œé—®é¢˜æ— æ³•æ”¶åˆ°æœåŠ¡å™¨è¿”å›çš„é¢„çº¦ç»“æœï¼Œå¯¼è‡´è¶…æ—¶ã€‚æ­¤æ—¶å¯ä»¥ç›´æ¥æ‰‹åŠ¨åˆ·æ–°é¡µé¢ï¼Œåœ¨å·²é¢„çº¦ä¿¡æ¯çš„éƒ¨åˆ†æ£€æŸ¥æ˜¯å¦é¢„çº¦æˆåŠŸï¼›</p>

	<h2>Change Log</h2>
	<p>v1.0, 2022.11.07: åŸºæœ¬åŠŸèƒ½ï¼šå®šæ—¶é¢„çº¦æŠ¢åœºåœ°</p>
	<p>v2.0 preview1, 2022.11.21: ç³»ç»Ÿæ·»åŠ äº†éªŒè¯ç ï¼Œæ›´æ¢äº†åŸºäºæµè§ˆå™¨çš„æ¡†æ¶ï¼Œä½¿å¾—å¯ä»¥æ‰‹å·¥è¾“å…¥éªŒè¯ç ï¼›åŒæ—¶æ”¯æŒè‡ªåŠ¨ç™»å½•</p>
	<p>v2.0 preview2, 2022.11.26: ä¿®å¤å‘¨æœ«é¢„çº¦å¤±è´¥çš„ bugï¼›éƒ¨åˆ†åŠŸèƒ½å®ç°ä» python æ”¹ä¸ºä½¿ç”¨ JavaScriptï¼Œé€Ÿåº¦æ›´å¿«</p>
	<p>v2.0 stable, 2022.11.27: ä¿®å¤å·¥ä½œæ—¥é¢„çº¦å¤±è´¥çš„ bug</p>
	<p>v2.1 preview1, 2022.11.28: ç ´è§£æ»‘åŠ¨éªŒè¯ç ï¼Œå®ç°å…¨æµç¨‹ 'end to end'ï¼Œå¦ˆå¦ˆå†ä¹Ÿä¸ç”¨æ‹…å¿ƒæˆ‘æ—© 8 èµ·ä¸æ¥å•¦</p>
	<p>v2.1 preview2, 2022.11.28: éƒ¨åˆ†åœºåœ°ä¿¡æ¯ä»ç¡¬ç¼–ç æ”¹ä¸ºåŠ¨æ€è·å–ï¼Œæé«˜é²æ£’æ€§</p>
	<p>v2.1 stable, 2022.12.02: ä¿®å¤äº†æ»‘åŠ¨éªŒè¯ç æœ‰ä¸€å®šæ¦‚ç‡å¤±è´¥çš„ bugï¼›æµ‹è¯•äº†ä¸åŒæ“ä½œç³»ç»Ÿå’Œæµè§ˆå™¨æ”¯æŒ</p>
	<p>v2.2 preview1, 2022.12.06: ç®€åŒ–ç®—æ³•ï¼Œæé«˜æ»‘åŠ¨éªŒè¯ç çš„è¯†åˆ«æ•ˆç‡ï¼›æä¾› headless é€‰é¡¹ï¼Œæ”¯æŒç›´æ¥éƒ¨ç½²åœ¨æœåŠ¡å™¨ä¸Šï¼ˆæš‚æœªæµ‹è¯•ï¼‰</p>
	<p>v3.0 preview1, 2022.12.11: æµ‹è¯•äº†æœåŠ¡å™¨éƒ¨ç½²ï¼Œå¹¶å¼€å‘äº†å¯¹åº”çš„æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ï¼Œä½¿ç”¨æ–¹ä¾¿ï¼Œæºç å¯æ§</p>
	<p>v3.1 preview1, 2022.12.18: å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯é€šä¿¡åŠ å¯†ï¼›æ‰“åŒ… windows ä¸€é”®åŒ…</p>
	<p>v3.1 stable, 2022.12.24: ä¿®å¤äº†æœåŠ¡ç«¯åœ¨éƒ¨åˆ†æœåŠ¡å™¨ä¸Šæ— æ³•å¯åŠ¨å’Œå¼‚å¸¸ç»“æŸçš„ bugï¼›æ›´å®Œå–„çš„å¼‚å¸¸å¤„ç†ï¼Œæé«˜é²æ£’æ€§ï¼›ä¼˜åŒ–æœåŠ¡ç«¯é€»è¾‘ï¼Œé™ä½èµ„æºå ç”¨ï¼›æ”¯æŒå®¢æˆ·ç«¯å¤šæ¬¡æäº¤è¯·æ±‚ï¼Œä»¥åå‘çš„ä¸ºå‡†</p>
	<p>v3.2 preview1, 2023.01.24: æœåŠ¡ç«¯æ”¯æŒåœ¨çº¿éªŒè¯ç”¨æˆ·ä¿¡æ¯ï¼Œå¯†ç é”™è¯¯/è§¦å‘éªŒè¯ç ç«‹å³æé†’ï¼›å®¢æˆ·ç«¯æ·»åŠ ä¸­æ–‡è¯­è¨€</p>
	<p>v3.2 preview2, 2023.02.14: ä¿®å¤åœºåœ°é€‰æ‹©çš„ bugï¼›å®¢æˆ·ç«¯äº¤äº’æ”¹è¿›</p>
	<p>v3.2 stable, 2023.02.18: å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ç‰ˆæœ¬ä¸€è‡´æ€§æ£€æŸ¥ï¼›å®¢æˆ·ç«¯äº¤äº’æ”¹è¿›ï¼›é€šè¿‡äº†æ›´å…¨é¢çš„æµ‹è¯•</p>
	<p>v4.0.0, 2023.03.13: html+js+ws é‡å†™å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ï¼Œè·¨å¹³å°ä½“éªŒæ›´ä½³</p>
	<p>v4.0.1, 2023.03.17: åŠ å…¥ fallback é€‰é¡¹ï¼Œé¡µé¢åŠ å…¥ ChangeLogï¼Œä¼˜åŒ– UI</p>
	<p>v4.0.2, 2023.03.28: ä¿®å¤å®¢æˆ·ç«¯ websocket ä¸èƒ½æ­£å¸¸å…³é—­çš„ bugï¼Œä¼˜åŒ– UI</p>
	<p>v4.0.3, 2023.04.26: æ·»åŠ ä¿å­˜è´¦å·å¯†ç é€‰é¡¹</p>
	<p>v4.1.0, 2023.05.08: å®Œå–„å¤šç”¨æˆ·é€»è¾‘ï¼Œæ·»åŠ åé¦ˆå’Œåˆ†çº§æœºåˆ¶</p>
	<p>v4.1.1, 2023.05.24: ä¿®å¤å¤šç”¨æˆ·bugï¼Œæ·»åŠ è¿œç¨‹è°ƒè¯•æ”¯æŒ</p>
	<p>v4.1.2, 2024.03.05: æ”¯æŒ docker éƒ¨ç½²ä»¥æ›´ä¼˜é›…åœ°è§£å†³ç¯å¢ƒä¾èµ–ï¼›æ·»åŠ è‡ªåŠ¨åˆ·æ–°æœºåˆ¶ï¼Œä¿®æ­£å®¢æˆ·ç«¯æ›´æ–°æ»åçš„é—®é¢˜</p>
	<p>v4.1.3, 2024.03.20: æ”¯æŒé€‰æ‹© 2 ä¸ªåœºåœ°ä»¥å¢å¼ºå®¹é”™ï¼›å°èŒƒå›´ä»£ç é‡æ„</p>
	<p>v4.2.0, 2024.07.05: ä¼˜åŒ– fallback é€»è¾‘ä¼˜å…ˆåŒæ—¶æ®µï¼›ç§»é™¤æœåŠ¡ç«¯è¿‡æ—¶æ— ç”¨çš„ session é€»è¾‘ï¼›æ·»åŠ  21-22 æ—¶æ®µï¼›ä¼˜åŒ– UI</p>
	<p>v5.0.0, 2024.08.17: å…¨é¢é‡æ„åç«¯ï¼Œä½¿ç”¨requestsè€Œéæµè§ˆå™¨è‡ªåŠ¨åŒ–å®ç°é¢„çº¦ä¸»æµç¨‹ï¼Œå¤§å¹…æé«˜å¯é æ€§å’Œæ•ˆç‡ï¼›ä¼˜åŒ–OCRéªŒè¯ç è¯†åˆ«æµç¨‹ï¼Œå¤§å¹…æé«˜éªŒè¯è´¦å·ä¿¡æ¯çš„é€Ÿåº¦</p>
</body>

<script>
	const reserve_start = 8, maintain_end = 11
	const pageRefreshIntervalDays = 3
	const progressTime = 20, waitTimeout = 10
	const totalImgNum = 7, opacity = 0.2
	const serverUrl = 'ws://210.28.135.34:65433'
	// const serverUrl = 'ws://127.0.0.1:65433'
	const desc_chn = {
		0: "æ“ä½œæˆåŠŸï¼Œæ‚¨å¯ä»¥é‡æ–°æäº¤ä»¥ä¿®æ”¹ä¿¡æ¯",
		1: "æ‚¨çš„è´¦å·æœªç»æˆæƒï¼Œè¯·è”ç³»å¼€å‘è€…",
		2: `æœåŠ¡å™¨äºæ¯æ—¥${reserve_start}:00-${maintain_end}:00ä¾‹è¡Œç»´æŠ¤ï¼Œè¯·äº${maintain_end}:00åå†é¢„çº¦`,
		3: "æ“ä½œæˆåŠŸ: æ‚¨ä»Šå¤©å·²ç»å‘é€äº†ä¸€æ¬¡é¢„çº¦è¯·æ±‚ï¼Œæœ¬æ¬¡è¯·æ±‚å·²ç»è¦†ç›–äº†ä¹‹å‰çš„ä¸€æ¬¡",
		4: "ç™»å½•å¤±è´¥ï¼Œå¯èƒ½åŸå› ï¼šå¯†ç é”™è¯¯",
		5: "ç™»å½•å¤±è´¥ï¼Œå¯èƒ½åŸå› ï¼šè§¦å‘äº†çŸ­ä¿¡éªŒè¯ç ï¼›è¯·ç«‹å³è‡ªè¡Œç™»å½•ä¸€æ¬¡ç³»ç»Ÿï¼Œç„¶åé‡è¯•",
		6: "ç™»å½•å¤±è´¥ï¼ŒæœªçŸ¥é”™è¯¯ï¼›å¦‚æœæ‚¨å¯ä»¥æ­£å¸¸æ‰‹åŠ¨ç™»å½•ï¼Œè¯·è”ç³»å¼€å‘è€…",
		10: "FORBIDDEN: æ‚¨å¯ä»¥å…ˆåˆ·æ–°é¡µé¢è¯•è¯•ï¼›å¦‚æœæ‚¨åšæŒè®¤ä¸ºè‡ªå·±æ²¡æœ‰é—®é¢˜ï¼Œè¯·è”ç³»å¼€å‘è€…",
		100: "æ­£åœ¨è¿æ¥æœåŠ¡å™¨...",
		101: "è¯·ç¨ç­‰ï¼Œæ­£åœ¨éªŒè¯æ‚¨çš„ä¿¡æ¯ï¼Œå¤§çº¦éœ€è¦30-45ç§’ï¼›è¯·ä¸è¦é”å±ï¼Œå¹¶å§‹ç»ˆå°†æœ¬é¡µé¢ç½®äºå‰å°ï¼Œç›´åˆ°æ”¶åˆ°ç»“æœæç¤º",
		102: "è¿æ¥å¤±è´¥æˆ–è¶…æ—¶ï¼›å¦‚æœæ‚¨ç¡®è®¤æ­£å¸¸æ¥å…¥äº†æ ¡å†…ç½‘ï¼Œè¯·å†è¯•ä¸€æ¬¡ï¼›è‹¥ä»ç„¶å¤±è´¥ï¼Œè¯·è”ç³»å¼€å‘è€…",
		103: "è¯·å°½é‡ä¸è¦ä½¿ç”¨è…¾è®¯å†…ç½®æµè§ˆå™¨ï¼Œå¦åˆ™æ‚¨çš„ä½“éªŒä¼šå—åˆ°å½±å“ï¼å»ºè®®ç‚¹å‡»å³ä¸Šè§’é€‰æ‹©æµè§ˆå™¨æ‰“å¼€",
		104: "å¸¦ * å·å­—æ®µå¿…å¡«ï¼",
	}

	var socket = null
	var currentTime = null

	function start() {
		check_version()
		load_resource()
		check_maintain()
		restore_passwd()
		document.addEventListener('DOMContentLoaded', () => {
			if (is_inner())
				show_message(desc_chn[103], false)
			socket = new WebSocket(serverUrl)
			socket.onerror = (_error => {
				show_message(desc_chn[102])
			})
			socket.addEventListener('message', on_status_received)
		})
	}

	function check_version() {
		currentTime = new Date().getTime()
		if (localStorage.last_fetch_timestamp) {
			var lastVisitTime = parseInt(localStorage.last_fetch_timestamp)
			var timeDifference = currentTime - lastVisitTime
			var daysDifference = timeDifference / (1000 * 60 * 60 * 24)
			if (daysDifference < pageRefreshIntervalDays)
				return
		}
		localStorage.last_fetch_timestamp = currentTime
		window.location.reload(true)
	}

	function on_status_received(event) {
		parent = document.getElementById('order')
		try {
			parent.removeChild(parent.firstChild)
		}
		catch (error) { }
		parent.appendChild(document.createTextNode(event.data))
	}

	function load_resource() {
		var node = null
		if (is_mobile()) {
			node = document.createElement('img')
			day = Math.floor(Date.now() / 1000 / 3600 / 24)
			node.src = `assets/bg-${day % totalImgNum + 1}.webp`
		}
		else {
			node = document.createElement('video')
			node.src = 'assets/bg.webm'
			node.autoplay = 'autoplay'
			node.loop = 'loop'
			node.muted = 'muted'
		}
		node.style.width = '100%'
		node.style.height = '100%'
		node.style.objectFit = 'cover'
		node.style.position = 'fixed'
		node.style.zIndex = '-1'
		node.style.top = '0'
		node.style.left = '0'
		node.style.opacity = `${opacity}`
		document.body.insertBefore(node, document.body.firstChild)
	}

	function check_maintain() {
		var button = document.getElementById('button')
		var hours = new Date().getHours()
		if (hours >= reserve_start && hours < maintain_end) {
			button.style.visibility = 'hidden'
			show_message(desc_chn[2])
		}
	}

	function restore_passwd() {
		const user = localStorage.getItem("user")
		if (user) {
			document.getElementById("user").value = user
			document.getElementById("password").value = localStorage.getItem("password")
		}
	}

	function is_inner() {
		var ua = navigator.userAgent.toLowerCase()
		if (ua.match(/MicroMessenger/i) == "micromessenger") {
			return "weixin"
		} else if (ua.match(/QQ/i) == "qq") {
			return "QQ"
		}
		return false
	}

	function is_mobile() {
		var userAgentInfo = navigator.userAgent.toLowerCase()
		var Agents = new Array("android", "iphone", "symbianos", "windows phone", "ipod")
		for (var v = 0; v < Agents.length; v++)
			if (userAgentInfo.indexOf(Agents[v]) > 0)
				return true
		return false
	}

	function show_message(msg, dialog = true) {
		var parent = document.getElementById('prompt')
		try {
			parent.removeChild(parent.firstChild)
		}
		catch (error) { }
		parent.appendChild(document.createTextNode(msg))
		if (dialog)
			alert(msg)
	}

	async function run() {
		// check args
		const time = document.getElementById("time").value
		const field = document.getElementById("field").value
		const type = document.getElementById("type").value
		// const alternative = document.getElementById("alternative").value
		const user = document.getElementById("user").value
		const password = document.getElementById("password").value
		if (!(time && user && field && password)) {
			show_message(desc_chn[104])
			return
		}
		if (document.getElementById("store_pwd").value) {
			localStorage.setItem("user", user)
			localStorage.setItem("password", password)
		}
		else {
			localStorage.removeItem("user")
			localStorage.removeItem("password")
		}
		var args_str = `--user ${user} --passwd ${password} -t ${type} -p ${time} -f ${field}`
		// if (alternative)
		// 	args_str += ` --alternative ${alternative}`
		if (document.getElementById("fallback").checked)
			args_str += ' --fallback'
		const args = await encrypt(args_str)
		console.log(args)

		var timer = setInterval(progress_step, progressTime)
		var timeoutId = null

		// send request
		socket.removeEventListener('message', on_status_received)
		socket.addEventListener('message', event => {
			clearInterval(timer)
			if (timeoutId != null)
				clearTimeout(timeoutId)
			progress.style.visibility = 'hidden'
			button.style.visibility = 'visible'
			status_code = event.data.charCodeAt(0)
			try {
				socket.close()
				show_message(desc_chn[status_code])
				localStorage.last_fetch_timestamp = currentTime
				location.reload(true)
			} catch (error) {
				show_message(`Unknown error: please report this bug to developer with the following error message: ${error}. Turn off or refresh this page before you continue.`)
			}
		})
		socket.onerror = (_error => {
			clearInterval(timer)
			progress.style.visibility = 'hidden'
			button.style.visibility = 'visible'
			show_message(desc_chn[102])
		})

		// show progress bar
		var button = document.getElementById("button")
		var progress = document.getElementById("progress")
		var bar = document.getElementById("progress_bar")
		var width = 0.0
		function progress_step() {
			if (width >= 99) {
				clearInterval(timer)
				timeoutId = setTimeout(() => {
					show_message(desc_chn[102])
					progress.style.visibility = 'hidden'
					button.style.visibility = 'visible'
					socket.close()
				}, waitTimeout * 1000)
			} else {
				width += 0.1
				bar.style.width = `${width}%`
				bar.innerHTML = `&nbsp;&nbsp;${parseInt(width)}%`
			}
			progress.style.visibility = 'visible'
			button.style.visibility = 'hidden'
		}

		socket.send(args)
		show_message(desc_chn[101], false)
	}

	async function encrypt(message) {
		// TODO: to be implemented
		return message
	}

	start()

</script>


</html>