<!DOCTYPE html>
<html>

<head>
	<title>Snores Client</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="Expires" content="0">
	<meta http-equiv="Pragma" content="no-cache">
	<meta http-equiv="Cache-control" content="no-cache">
	<meta http-equiv="Cache" content="no-cache">
</head>

<link rel="shortcut icon" href="assets/icon.png" />

<body>
	<!-- <video src="assets/bg.webm"
		style="width: 100%; height: 100%; object-fit: cover; position: fixed; z-index: -1; top: 0; left: 0; opacity: 0.15;"
		autoplay="autoplay" loop="loop" muted="muted"></video> -->
	<h1>SnoresğŸ’¤</h1>
	<p><b>S</b>cript for <b>N</b>JU Sp<b>o</b>rt <b>Re</b>servation <b>S</b>ystem</p>
	<p>Run this script and SNORE happily next morning - the server will do everything for you!</p>
	<p>Version 4.1.1, copyright (c) 2022~2023 by starreeze (starreeze@foxmail.com).</p>


	<h2>Usage</h2>
	å¡«å†™ä¸‹é¢çš„ä¿¡æ¯ï¼Œç‚¹å‡» SNORES! å³å¯é¢„çº¦æ˜å¤©çš„åœºåœ°ã€‚<br><br>
	ç›®å‰ï¼ˆå…¶ä»–äººä½¿ç”¨æœ¬è„šæœ¬çš„ï¼‰é¢„çº¦æƒ…å†µï¼ˆè¯·ä¸»åŠ¨é¿å¼€ï¼Œå¦åˆ™ä¼šé¢„çº¦å¤±è´¥ï¼‰ï¼š
	<p id="order" style="color: crimson;">æ­£åœ¨åŠ è½½åœºåœ°ä¿¡æ¯ï¼Œè¯·ä¸è¦ç‚¹å‡»SNORESæŒ‰é’®â€¦â€¦</p>
	<br><br>
	<form>
		<label for="type" style="width: 130px; float: left;">*åœºåœ°ç±»å‹:</label>
		<select id="type" name="type">
			<option value="0">æ–¹æ–¹è‚‡å‘¨ç¾½æ¯›çƒï¼ˆæ¥¼ä¸‹ï¼‰</option>
			<option value="1">æ–¹è‚‡å‘¨ç¾½æ¯›çƒï¼ˆæ¥¼ä¸Šï¼‰</option>
			<option value="2">æ–¹è‚‡å‘¨ä¹’ä¹“çƒ</option>
			<option value="5" selected="selected">å››ç»„å›¢ç¾½æ¯›çƒ</option>
		</select><br><br>
		<label for="time" style="width: 130px; float: left;">*æ—¶é—´æ®µ:</label>
		<select id="time" name="time">
			<option value="9">9-10</option>
			<option value="10">10-11</option>
			<option value="11">11-12</option>
			<option value="12">12-13</option>
			<option value="13">13-14</option>
			<option value="14">14-15</option>
			<option value="15">15-16</option>
			<option value="16">16-17</option>
			<option value="17">17-18</option>
			<option value="18">18-19</option>
			<option value="19" selected="selected">19-20</option>
			<option value="20">20-21</option>
		</select><br><br>
		<label for="field" style="width: 240px; float: left;">*åœºåœ°ï¼ˆç›´æ¥è¾“å…¥æ•°å­—ï¼‰:</label>
		<input type="text" id="field" name="field" value="1" style="width: 60px;"><br><br>
		<label for="user" style="width: 130px; float: left;">*å­¦å·: </label>
		<input type="text" id="user"><br><br>
		<label for="password" style="width: 130px; float: left;">*ç»Ÿä¸€è®¤è¯å¯†ç :</label>
		<input type="password" id="password" name="password"><br><br>
		<input type="checkbox" id="fallback" name="fallback">
		<label for="fallback">å¦‚æœæ»¡è¶³æ¡ä»¶çš„åœºåœ°æ— æ³•é€‰æ‹©ï¼Œå¸®æˆ‘ä»»æ„é€‰æ‹©ä¸€ä¸ªå…¶ä»–çš„</label><br><br>
		<input type="checkbox" id="store_pwd" name="store_pwd" checked="true">
		<label for="store_pwd">å°†æˆ‘çš„è´¦å·å¯†ç ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­ï¼Œä¾¿äºä¸‹æ¬¡ä½¿ç”¨</label><br><br>
	</form>
	<button type="button" onclick="run()" id="button"
		style="width: 180px; height: 40px; color: crimson; background-color: lightcyan;">
		SNORES!
	</button>

	<div id="progress" style="width: 100%; background-color: #ddd; visibility: hidden;">
		<div id="progress_bar"
			style="width: 0%; height: 30px; background-color: #4CAF50; line-height: 30px; color: white;"></div>
	</div>

	<p id="prompt" style="color: crimson;"></p>


	<h2>Introduction</h2>
	<p>å—äº¬å¤§å­¦ä½“è‚²åœºåœ°é¢„çº¦è„šæœ¬ï¼ˆå®¢æˆ·ç«¯ï¼‰ï¼Œç›®å‰ä»…æ”¯æŒç¾½æ¯›çƒã€ä¹’ä¹“çƒã€‚</p>
	<p>ç›®å‰ä¸ºé˜²æ­¢æ»¥ç”¨ï¼ŒæœåŠ¡ç«¯ä»…å¯¹å·²è·æˆæƒçš„è´¦æˆ·å¼€æ”¾é¢„çº¦æœåŠ¡ã€‚è¦è·å–æˆæƒï¼Œè¯·è”ç³»starreeze@foxmail.comã€‚</p>
	<p>å½“å¤© 8 ç‚¹å‰æˆ–å‰ä¸€å¤© 9 ç‚¹åè¿è¡Œå®¢æˆ·ç«¯å‘é€è¯·æ±‚ï¼ŒæœåŠ¡å™¨ä¼šåœ¨ 8 ç‚¹æ•´å¼€å§‹æ‰§è¡Œé¢„çº¦æ“ä½œã€‚æœåŠ¡ç«¯ç¨‹åºä¼šè°ƒå‡ºæµè§ˆå™¨ï¼Œå¹¶è‡ªåŠ¨å®Œæˆç™»å½•ã€é€‰æ‹©åœºåœ°ã€é€‰æ‹©åŒä¼´ã€æ»‘åŠ¨éªŒè¯ç ã€æ”¯ä»˜ç­‰æ“ä½œï¼Œå¯ä»¥æ¯”æ‰‹åŠ¨æ“ä½œèŠ‚çœ
		2-3sï¼Œæé«˜æˆåŠŸç‡ï¼›åŒæ—¶å†ä¹Ÿä¸ç”¨æ€•æ—© 8 èµ·ä¸æ¥äº†ã€‚</p>
	<p>ç›®å‰ä¿¡æ¯ä½¿ç”¨æ˜æ–‡ä¼ è¾“ï¼Œè¯·ç¡®ä¿ç½‘ç»œç¯å¢ƒå®‰å…¨ï¼›å¼€å‘è€…æ‰¿è¯ºï¼Œä¸ä¼šå°†ç”¨æˆ·ä¿¡æ¯å’Œå¯†ç ç”¨äºé™¤ç™»å½•é¢„çº¦ç³»ç»Ÿå¤–çš„ä»»ä½•ç”¨é€”ï¼›æœåŠ¡å™¨åœ¨æ ¡å†…ï¼Œä¸€æ—¦å‡ºç°é—®é¢˜å¯æº¯æºï¼šè¯·æ”¾å¿ƒä½¿ç”¨ã€‚</p>
	<p>ä½¿ç”¨å‰è¯·ç¡®ä¿åœ¨ç³»ç»Ÿä¸­æ·»åŠ äº†è‡³å°‘ä¸€ä¸ªåŒä¼´ï¼Œå°†ä¼šé»˜è®¤ä½¿ç”¨ç¬¬ä¸€ä¸ªåŒä¼´ã€‚</p>

	<h2>Known Issues</h2>
	<p>client&serverï¼šéªŒè¯èº«ä»½ä¿¡æ¯æ—¶ï¼Œè¿›ç¨‹å¼‚å¸¸å¡æ­»ï¼Œè§¦å‘è¶…æ—¶ï¼ˆä»…å‡ºç°è¿‡1æ¬¡ï¼‰</p>
	<p>é¢„çº¦ä¸»ç¨‹åºï¼šè·å–åœºåœ°ä¿¡æ¯æ—¶ï¼Œè¯»å–èµ·å§‹/ç»“æŸæ—¶é—´å­—ç¬¦ä¸²ä¸ºç©ºï¼ˆä»…å‡ºç°è¿‡1æ¬¡ï¼‰</p>

	<h2>Change Log</h2>
	<p>v1.0, 2022.11.07: åŸºæœ¬åŠŸèƒ½ï¼šå®šæ—¶é¢„çº¦æŠ¢åœºåœ°</p>
	<p>v2.0 preview1, 2022.11.21: ç³»ç»Ÿæ·»åŠ äº†éªŒè¯ç ï¼Œæ›´æ¢äº†åŸºäºæµè§ˆå™¨çš„æ¡†æ¶ï¼Œä½¿å¾—å¯ä»¥æ‰‹å·¥è¾“å…¥éªŒè¯ç ï¼›åŒæ—¶æ”¯æŒè‡ªåŠ¨ç™»å½•</p>
	<p>v2.0 preview2, 2022.11.26: ä¿®å¤å‘¨æœ«é¢„çº¦å¤±è´¥çš„ bugï¼›éƒ¨åˆ†åŠŸèƒ½å®ç°ä» python æ”¹ä¸ºä½¿ç”¨ JavaScriptï¼Œé€Ÿåº¦æ›´å¿«</p>
	<p>v2.0 stable, 2022.11.27: ä¿®å¤å·¥ä½œæ—¥é¢„çº¦å¤±è´¥çš„ bug</p>
	<p>v2.1 preview1, 2022.11.28: ç ´è§£æ»‘åŠ¨éªŒè¯ç ï¼Œå®ç°å…¨æµç¨‹ 'end to end'ï¼Œå¦ˆå¦ˆå†ä¹Ÿä¸ç”¨æ‹…å¿ƒæˆ‘æ—© 8 èµ·ä¸æ¥å•¦</p>
	<p>v2.1 preview2, 2022.11.28: éƒ¨åˆ†åœºåœ°ä¿¡æ¯ä»ç¡¬ç¼–ç æ”¹ä¸ºåŠ¨æ€è·å–ï¼Œæé«˜é²æ£’æ€§</p>
	<p>v2.1 stable, 2022.12.02: ä¿®å¤äº†æ»‘åŠ¨éªŒè¯ç æœ‰ä¸€å®šæ¦‚ç‡å¤±è´¥çš„ bugï¼›æµ‹è¯•äº†ä¸åŒæ“ä½œç³»ç»Ÿå’Œæµè§ˆå™¨æ”¯æŒ</p>
	<p>v2.2 preview1, 2022.12.06: ç®€åŒ–ç®—æ³•ï¼Œæé«˜æ»‘åŠ¨éªŒè¯ç çš„è¯†åˆ«æ•ˆç‡ï¼›æä¾› headless é€‰é¡¹ï¼Œæ”¯æŒç›´æ¥éƒ¨ç½²åœ¨æœåŠ¡å™¨ä¸Šï¼ˆæš‚æœªæµ‹è¯•ï¼‰</p>
	<p>v3.0 preview1, 2022.12.11: æµ‹è¯•äº†æœåŠ¡å™¨éƒ¨ç½²ï¼Œå¹¶å¼€å‘äº†å¯¹åº”çš„æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ï¼Œä½¿ç”¨æ–¹ä¾¿ï¼Œæºç å¯æ§</p>
	<p>v3.1 preview1, 2022.12.18: å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯é€šä¿¡åŠ å¯†ï¼›æ‰“åŒ… windows ä¸€é”®åŒ…</p>
	<p>v3.1 stable, 2022.12.24: ä¿®å¤äº†æœåŠ¡ç«¯åœ¨éƒ¨åˆ†æœåŠ¡å™¨ä¸Šæ— æ³•å¯åŠ¨å’Œå¼‚å¸¸ç»“æŸçš„ bugï¼›æ›´å®Œå–„çš„å¼‚å¸¸å¤„ç†ï¼Œæé«˜é²æ£’æ€§ï¼›ä¼˜åŒ–æœåŠ¡ç«¯é€»è¾‘ï¼Œé™ä½èµ„æºå ç”¨ï¼›æ”¯æŒå®¢æˆ·ç«¯å¤šæ¬¡æäº¤è¯·æ±‚ï¼Œä»¥åå‘çš„ä¸ºå‡†</p>
	<p>v3.2 preview1, 2023.01.24: æœåŠ¡ç«¯æ”¯æŒåœ¨çº¿éªŒè¯ç”¨æˆ·ä¿¡æ¯ï¼Œå¯†ç é”™è¯¯/è§¦å‘éªŒè¯ç ç«‹å³æé†’ï¼›å®¢æˆ·ç«¯æ·»åŠ ä¸­æ–‡è¯­è¨€</p>
	<p>v3.2 preview2, 2023.02.14: ä¿®å¤åœºåœ°é€‰æ‹©çš„ bugï¼›å®¢æˆ·ç«¯äº¤äº’æ”¹è¿›</p>
	<p>v3.2 stable, 2023.02.18: å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ç‰ˆæœ¬ä¸€è‡´æ€§æ£€æŸ¥ï¼›å®¢æˆ·ç«¯äº¤äº’æ”¹è¿›ï¼›é€šè¿‡äº†æ›´å…¨é¢çš„æµ‹è¯•</p>
	<p>v4.0.0, 2023.03.13: html+js+ws é‡å†™å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ï¼Œè·¨å¹³å°ä½“éªŒæ›´ä½³</p>
	<p>v4.0.1, 2023.03.17: åŠ å…¥ fallback é€‰é¡¹ï¼Œé¡µé¢åŠ å…¥ ChangeLogï¼Œä¼˜åŒ– UI</p>
	<p>v4.0.2, 2023.03.28: ä¿®å¤å®¢æˆ·ç«¯ websocket ä¸èƒ½æ­£å¸¸å…³é—­çš„ bugï¼Œä¼˜åŒ– UI</p>
	<p>v4.0.3, 2023.04.26: æ·»åŠ ä¿å­˜è´¦å·å¯†ç é€‰é¡¹</p>
	<p>v4.1.0, 2023.05.08: å®Œå–„å¤šç”¨æˆ·é€»è¾‘ï¼Œæ·»åŠ åé¦ˆå’Œåˆ†çº§æœºåˆ¶</p>
	<p>v4.1.1, 2023.05.24: ä¿®å¤å¤šç”¨æˆ·bugï¼Œæ·»åŠ è¿œç¨‹è°ƒè¯•æ”¯æŒ</p>
</body>

<script>
	const progressTime = 40, waitTimeout = 30
	const totalImgNum = 7, opacity = 0.2
	const serverUrl = 'ws://210.28.135.91:65433'
	// const serverUrl = 'ws://127.0.0.1:65433'
	const desc_chn = {
		0: "æ“ä½œæˆåŠŸï¼Œæ‚¨å¯ä»¥é‡æ–°æäº¤ä»¥ä¿®æ”¹ä¿¡æ¯",
		1: "æ‚¨çš„è´¦å·æœªç»æˆæƒï¼Œè¯·è”ç³»å¼€å‘è€…",
		2: "æ‚¨æ¥å¾—å¤ªæ™šï¼ˆæ—©ï¼Ÿï¼‰äº†ï¼Œå¦‚æ‚¨è®¡åˆ’é¢„çº¦æ˜å¤©çš„åœºåœ°ï¼Œè¯·äº9:00åé‡è¯•",
		3: "æ“ä½œæˆåŠŸ: æ‚¨ä»Šå¤©å·²ç»å‘é€äº†ä¸€æ¬¡é¢„çº¦è¯·æ±‚ï¼Œæœ¬æ¬¡è¯·æ±‚å·²ç»è¦†ç›–äº†ä¹‹å‰çš„ä¸€æ¬¡",
		4: "ç™»å½•å¤±è´¥ï¼Œå¯èƒ½åŸå› ï¼šå¯†ç é”™è¯¯",
		5: "ç™»å½•å¤±è´¥ï¼Œå¯èƒ½åŸå› ï¼šè§¦å‘äº†çŸ­ä¿¡éªŒè¯ç ï¼›è¯·ç«‹å³è‡ªè¡Œç™»å½•ä¸€æ¬¡ç³»ç»Ÿï¼Œç„¶åé‡è¯•",
		6: "ç™»å½•å¤±è´¥ï¼ŒæœªçŸ¥é”™è¯¯ï¼›å¦‚æœæ‚¨å¯ä»¥æ­£å¸¸æ‰‹åŠ¨ç™»å½•ï¼Œè¯·è”ç³»å¼€å‘è€…",
		10: "FORBIDDEN: å¦‚æœæ‚¨åšæŒè®¤ä¸ºè‡ªå·±æ²¡æœ‰é—®é¢˜ï¼Œè¯·è”ç³»å¼€å‘è€…",
		100: "æ­£åœ¨è¿æ¥æœåŠ¡å™¨...",
		101: "è¯·ç¨ç­‰ï¼Œæ­£åœ¨éªŒè¯æ‚¨çš„ä¿¡æ¯ï¼Œå¤§çº¦éœ€è¦30-45ç§’ï¼›è¯·ä¸è¦é”å±ï¼Œå¹¶å§‹ç»ˆå°†æœ¬é¡µé¢ç½®äºå‰å°ï¼Œç›´åˆ°æ”¶åˆ°ç»“æœæç¤º",
		102: "è¿æ¥å¤±è´¥æˆ–è¶…æ—¶ï¼›å¦‚æœæ‚¨ç¡®è®¤æ­£å¸¸æ¥å…¥äº†æ ¡å†…ç½‘ï¼Œè¯·å†è¯•ä¸€æ¬¡ï¼›è‹¥ä»ç„¶å¤±è´¥ï¼Œè¯·è”ç³»å¼€å‘è€…",
		103: "è¯·å°½é‡ä¸è¦ä½¿ç”¨è…¾è®¯å†…ç½®æµè§ˆå™¨ï¼Œå¦åˆ™æ‚¨çš„ä½“éªŒä¼šå—åˆ°å½±å“ï¼å»ºè®®ç‚¹å‡»å³ä¸Šè§’é€‰æ‹©æµè§ˆå™¨æ‰“å¼€",
		104: "å¸¦ * å·å­—æ®µå¿…å¡«ï¼",
	}

	var socket = null

	function start() {
		load_resource()
		restore_passwd()
		document.addEventListener('DOMContentLoaded', () => {
			if (is_inner())
				show_message(desc_chn[103], false)
			socket = new WebSocket(serverUrl)
			socket.onerror = (_error => {
				show_message(desc_chn[102])
			})
			socket.addEventListener('message', on_status_received)
		})
	}

	function on_status_received(event) {
		parent = document.getElementById('order')
		try {
			parent.removeChild(parent.firstChild)
		}
		catch (error) { }
		parent.appendChild(document.createTextNode(event.data))
	}

	function load_resource() {
		var node = null
		if (is_mobile()) {
			node = document.createElement('img')
			day = Math.floor(Date.now() / 1000 / 3600 / 24)
			node.src = `assets/bg-${day % totalImgNum + 1}.webp`
		}
		else {
			node = document.createElement('video')
			node.src = 'assets/bg.webm'
			node.autoplay = 'autoplay'
			node.loop = 'loop'
			node.muted = 'muted'
		}
		node.style.width = '100%'
		node.style.height = '100%'
		node.style.objectFit = 'cover'
		node.style.position = 'fixed'
		node.style.zIndex = '-1'
		node.style.top = '0'
		node.style.left = '0'
		node.style.opacity = `${opacity}`
		document.body.insertBefore(node, document.body.firstChild)
	}

	function restore_passwd() {
		const user = localStorage.getItem("user")
		if (user) {
			document.getElementById("user").value = user
			document.getElementById("password").value = localStorage.getItem("password")
		}
	}

	function is_inner() {
		var ua = navigator.userAgent.toLowerCase()
		if (ua.match(/MicroMessenger/i) == "micromessenger") {
			return "weixin"
		} else if (ua.match(/QQ/i) == "qq") {
			return "QQ"
		}
		return false
	}

	function is_mobile() {
		var userAgentInfo = navigator.userAgent.toLowerCase()
		var Agents = new Array("android", "iphone", "symbianos", "windows phone", "ipod")
		for (var v = 0; v < Agents.length; v++)
			if (userAgentInfo.indexOf(Agents[v]) > 0)
				return true
		return false
	}

	function show_message(msg, dialog = true) {
		var parent = document.getElementById('prompt')
		try {
			parent.removeChild(parent.firstChild)
		}
		catch (error) { }
		parent.appendChild(document.createTextNode(msg))
		if (dialog)
			alert(msg)
	}

	async function run() {
		// check args
		const time = document.getElementById("time").value
		const field = document.getElementById("field").value
		const type = document.getElementById("type").value
		const user = document.getElementById("user").value
		const password = document.getElementById("password").value
		if (!(time && user && field && password)) {
			show_message(desc_chn[104])
			return
		}
		if (document.getElementById("store_pwd").value) {
			localStorage.setItem("user", user)
			localStorage.setItem("password", password)
		}
		else {
			localStorage.removeItem("user")
			localStorage.removeItem("password")
		}
		var args_str = `--user ${user} --passwd ${password} -t ${type} -p ${time}`
		if (field)
			args_str += ` -f ${field}`
		if (document.getElementById("fallback").checked)
			args_str += ' --fallback'
		const args = await encrypt(args_str)
		console.log(args)

		var timer = setInterval(progress_step, progressTime)
		var timeoutId = null

		// send request
		socket.removeEventListener('message', on_status_received)
		socket.addEventListener('message', event => {
			clearInterval(timer)
			if (timeoutId != null)
				clearTimeout(timeoutId)
			progress.style.visibility = 'hidden'
			button.style.visibility = 'visible'
			status_code = event.data.charCodeAt(0)
			try {
				socket.close()
				show_message(desc_chn[status_code])
			} catch (error) {
				show_message(`Unknown error: please report this bug to developer with the following error message: ${error}. Turn off or refresh this page before you continue.`)
			}
		})
		socket.onerror = (_error => {
			clearInterval(timer)
			progress.style.visibility = 'hidden'
			button.style.visibility = 'visible'
			show_message(desc_chn[102])
		})

		// show progress bar
		var button = document.getElementById("button")
		var progress = document.getElementById("progress")
		var bar = document.getElementById("progress_bar")
		var width = 0.0
		function progress_step() {
			if (width >= 99) {
				clearInterval(timer)
				timeoutId = setTimeout(() => {
					show_message(desc_chn[102])
					progress.style.visibility = 'hidden'
					button.style.visibility = 'visible'
					socket.close()
				}, waitTimeout * 1000)
			} else {
				width += 0.1
				bar.style.width = `${width}%`
				bar.innerHTML = `&nbsp;&nbsp;${parseInt(width)}%`
			}
			progress.style.visibility = 'visible'
			button.style.visibility = 'hidden'
		}

		socket.send(args)
		show_message(desc_chn[101], false)
	}

	async function encrypt(message) {
		return message
	}

	start()

</script>


</html>